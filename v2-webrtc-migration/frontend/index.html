<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Remote Chromium ‚Äì WebRTC</title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      background: black;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: black;
    }

    #status {
      position: absolute;
      top: 8px;
      left: 8px;
      padding: 6px 10px;
      background: rgba(0,0,0,0.6);
      color: #0f0;
      font-family: monospace;
      font-size: 12px;
      z-index: 10;
    }
  </style>
</head>
<body>

<div id="status">Connecting‚Ä¶</div>
<video id="video" autoplay playsinline muted></video>

<script>
/* ===============================
   WebRTC + WebSocket Client
   =============================== */

const statusEl = document.getElementById("status");
const videoEl = document.getElementById("video");

let pc = null;
let ws = null;

/* ---------- PeerConnection ---------- */

function createPeerConnection() {
  pc = new RTCPeerConnection({
    iceServers: [
      { urls: "stun:stun.l.google.com:19302" }
    ]
  });

  pc.ontrack = (event) => {
    console.log("üé• Video track received");
    videoEl.srcObject = event.streams[0];
    statusEl.textContent = "Streaming";
  };

  pc.onicecandidate = (event) => {
    if (event.candidate && ws?.readyState === WebSocket.OPEN) {
      ws.send(JSON.stringify({
        type: "ice",
        sdpMLineIndex: event.candidate.sdpMLineIndex,
        candidate: event.candidate.candidate
      }));
    }
  };
}

/* ---------- WebSocket (with retry) ---------- */

function connectWebSocket() {
  statusEl.textContent = "Connecting to signaling‚Ä¶";
  console.log("üîÑ Connecting to ws://localhost:9000");

  ws = new WebSocket("ws://localhost:9000");

  ws.onopen = () => {
    console.log("‚úÖ WebSocket connected");
    statusEl.textContent = "Connected ‚Äì waiting for offer";
  };

  ws.onmessage = async (event) => {
    const msg = JSON.parse(event.data);
    console.log("üì© Signal:", msg.type);

    if (msg.type === "offer") {
      if (!pc) createPeerConnection();

      await pc.setRemoteDescription({
        type: "offer",
        sdp: msg.sdp
      });

      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      ws.send(JSON.stringify({
        type: "answer",
        sdp: answer.sdp
      }));

      statusEl.textContent = "Negotiating‚Ä¶";
    }

    if (msg.type === "ice" && pc) {
      await pc.addIceCandidate({
        candidate: msg.candidate,
        sdpMLineIndex: msg.sdpMLineIndex
      });
    }
  };

  ws.onerror = (err) => {
    console.warn("‚ö† WebSocket error", err);
    ws.close();
  };

  ws.onclose = () => {
    console.warn("‚ùå WebSocket closed, retrying in 1s‚Ä¶");
    statusEl.textContent = "Reconnecting‚Ä¶";

    if (pc) {
      pc.close();
      pc = null;
    }

    setTimeout(connectWebSocket, 1000);
  };
}

/* ---------- Start ---------- */

createPeerConnection();
connectWebSocket();
</script>

</body>
</html>
